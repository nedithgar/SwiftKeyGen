name: CI

on:
  push:
    branches: [ main, chore/**, feat/**, fix/**, refactor/**, test/** ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    name: Build & Test (${{ matrix.os }} - Swift 6.2)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # TODO: Disable Linux and Windows temporarily
        os: [ubuntu-latest, macos-26, windows-latest]
        # os: [ubuntu-latest, macos-26]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift 6.2 (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euxo pipefail
          SWIFT_VERSION=6.2
          # Try current ubuntu version first, fallback to previous LTS if needed
          for DIST in ubuntu24.04 ubuntu22.04; do
            TARBALL="swift-${SWIFT_VERSION}-RELEASE-${DIST}.tar.gz"
            BASE_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/${DIST}/swift-${SWIFT_VERSION}-RELEASE"
            URL="${BASE_URL}/${TARBALL}"
            echo "Attempting download: $URL"
            if curl -fSOL "$URL"; then
              curl -fSOL "${URL}.sig" || true
              tar -xzf "$TARBALL"
              sudo mv "swift-${SWIFT_VERSION}-RELEASE-${DIST}" /opt/swift-${SWIFT_VERSION}
              echo "/opt/swift-${SWIFT_VERSION}/usr/bin" >> "$GITHUB_PATH"
              break
            fi
          done
          swift --version

      - name: Install Swift 6.2 (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euxo pipefail
          SWIFT_VERSION=6.2
            PKG="swift-${SWIFT_VERSION}-RELEASE-osx.pkg"
            URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/xcode/swift-${SWIFT_VERSION}-RELEASE/${PKG}"
            curl -fSOL "$URL"
            sudo installer -pkg "$PKG" -target /
            TOOLCHAIN="/Library/Developer/Toolchains/swift-${SWIFT_VERSION}-RELEASE.xctoolchain/usr/bin"
            echo "$TOOLCHAIN" >> "$GITHUB_PATH"
            swift --version

      - name: Install prerequisites (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # Install required Visual Studio components only if MSVC tools aren't already available
          if (-not (Get-Command cl.exe -ErrorAction SilentlyContinue)) {
            Write-Host "Installing Visual Studio 2022 components required by Swift..."
            winget install --id Microsoft.VisualStudio.2022.Community --exact --force --accept-source-agreements --accept-package-agreements --custom "--add Microsoft.VisualStudio.Component.Windows11SDK.22000 --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.VC.Tools.ARM64"
          } else {
            Write-Host "MSVC tools detected; skipping Visual Studio installation."
          }

      - name: Install Swift 6.2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $versionsToTry = @('6.2','6.2.0')
          $installed = $false
          foreach ($v in $versionsToTry) {
            try {
              winget install --id Swift.Toolchain -e --version $v --accept-source-agreements --accept-package-agreements
              $installed = $true
              $swiftVersion = $v
              break
            } catch {
              Write-Host "Failed to install Swift.Toolchain version $v, trying next..."
            }
          }
          if (-not $installed) { throw "Unable to install Swift.Toolchain 6.2.x via winget." }

          $toolchainRoot = 'C:\\Library\\Developer\\Toolchains'
          if (Test-Path $toolchainRoot) {
            $candidates = Get-ChildItem $toolchainRoot | Sort-Object LastWriteTime -Descending
            $selected = $null
            foreach ($c in $candidates) {
              if ($c.Name -match '6\\.2') { $selected = $c; break }
            }
            if (-not $selected) { $selected = $candidates | Select-Object -First 1 }
            if (-not $selected) { throw "Swift toolchain directory not found in $toolchainRoot" }
            "$(($selected.FullName))\\usr\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            throw "Toolchain root $toolchainRoot not found after installation."
          }
          swift --version

      - name: Configure Git (Windows NTFS quirk)
        if: runner.os == 'Windows'
        shell: pwsh
        run: git config --global core.protectNTFS false

      - name: Print Swift Version
        run: swift --version

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build (Release)
        run: swift build -c release

        # TODO: Disable tests temporarily
    #   - name: Run Full Test Suite (Release Mode)
    #     run: |
    #       swift test -c release
    #     shell: bash

      - name: Archive Build Products (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          cp -R .build/release artifacts/build-release
        shell: bash

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-swift6.2
          path: artifacts