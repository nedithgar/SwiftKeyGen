name: CI

on:
  push:
    branches: [ main, chore/**, feat/**, fix/**, refactor/**, test/** ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    name: Build & Test (${{ matrix.os }} - Swift 6.2)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # TODO: Disable Linux and Windows temporarily
        # os: [ubuntu-latest, macos-26, windows-latest]
        os: [ubuntu-latest, macos-26]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift 6.2 (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euxo pipefail
          SWIFT_VERSION=6.2
          # Try current ubuntu version first, fallback to previous LTS if needed
          for DIST in ubuntu24.04 ubuntu22.04; do
            TARBALL="swift-${SWIFT_VERSION}-RELEASE-${DIST}.tar.gz"
            BASE_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/${DIST}/swift-${SWIFT_VERSION}-RELEASE"
            URL="${BASE_URL}/${TARBALL}"
            echo "Attempting download: $URL"
            if curl -fSOL "$URL"; then
              curl -fSOL "${URL}.sig" || true
              tar -xzf "$TARBALL"
              sudo mv "swift-${SWIFT_VERSION}-RELEASE-${DIST}" /opt/swift-${SWIFT_VERSION}
              echo "/opt/swift-${SWIFT_VERSION}/usr/bin" >> "$GITHUB_PATH"
              break
            fi
          done
          swift --version

      - name: Install Swift 6.2 (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euxo pipefail
          SWIFT_VERSION=6.2
            PKG="swift-${SWIFT_VERSION}-RELEASE-osx.pkg"
            URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/xcode/swift-${SWIFT_VERSION}-RELEASE/${PKG}"
            curl -fSOL "$URL"
            sudo installer -pkg "$PKG" -target /
            TOOLCHAIN="/Library/Developer/Toolchains/swift-${SWIFT_VERSION}-RELEASE.xctoolchain/usr/bin"
            echo "$TOOLCHAIN" >> "$GITHUB_PATH"
            swift --version

      - name: Install Swift 6.2 (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $version = '6.2'
          winget install --id Swift.Toolchain -e --version $version --accept-source-agreements --accept-package-agreements
          $toolchain = Get-ChildItem 'C:\Library\Developer\Toolchains' | Where-Object { $_.Name -like "*${version}*" } | Select-Object -First 1
          if (-not $toolchain) { Write-Error 'Swift toolchain not found after install.' }
          "$($toolchain.FullName)\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          swift --version

      - name: Print Swift Version
        run: swift --version

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build (Release)
        run: swift build -c release

        # TODO: Disable tests temporarily
    #   - name: Run Full Test Suite (Release Mode)
    #     run: |
    #       swift test -c release
    #     shell: bash

      - name: Archive Build Products (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          cp -R .build/release artifacts/build-release
        shell: bash

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-swift6.2
          path: artifacts