name: CI

on:
  push:
    branches: [ main, chore/**, feat/**, fix/**, refactor/**, test/** ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    name: Build & Test (${{ matrix.os }} - Swift 6.2)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-26, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift 6.2 (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euxo pipefail
          SWIFT_VERSION=6.2

          # If the required Swift version is already available, skip installation.
          if swift --version 2>/dev/null | grep -q "Swift version ${SWIFT_VERSION}"; then
            echo "Swift ${SWIFT_VERSION} already installed on runner."
          else
            # Install Swiftly (official Swift.org installer/manager) and use it to install Swift ${SWIFT_VERSION}
            ARCH="$(uname -m)"
            SWIFTLY_TARBALL="swiftly-${ARCH}.tar.gz"
            curl -fSLo "${SWIFTLY_TARBALL}" "https://download.swift.org/swiftly/linux/${SWIFTLY_TARBALL}"
            tar zxf "${SWIFTLY_TARBALL}"
            ./swiftly init --quiet-shell-followup
            # Load environment so 'swiftly' is available in this step
            . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
            # Install exact Swift version
            swiftly install "${SWIFT_VERSION}"
            # Persist Swiftly bin path for subsequent steps
            echo "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/bin" >> "$GITHUB_PATH"
            hash -r
          fi

          swift --version

      - name: Install Swift 6.2 (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euxo pipefail
          SWIFT_VERSION=6.2
            PKG="swift-${SWIFT_VERSION}-RELEASE-osx.pkg"
            URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/xcode/swift-${SWIFT_VERSION}-RELEASE/${PKG}"
            curl -fSOL "$URL"
            sudo installer -pkg "$PKG" -target /
            TOOLCHAIN="/Library/Developer/Toolchains/swift-${SWIFT_VERSION}-RELEASE.xctoolchain/usr/bin"
            echo "$TOOLCHAIN" >> "$GITHUB_PATH"
            swift --version

      - name: Install Swift 6.2 (Windows - manual)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $SwiftVersion = 'swift-6.2-release'
          $SwiftBuild = '6.2-RELEASE'
          $Arch = 'amd64'

          # Compose download URL for official swift.org release
          if ($Arch -eq 'amd64') {
            $URL = "https://download.swift.org/$SwiftVersion/windows10/swift-$SwiftBuild/swift-$SwiftBuild-windows10.exe"
          } else {
            $URL = "https://download.swift.org/$SwiftVersion/windows10-$Arch/swift-$SwiftBuild/swift-$SwiftBuild-windows10-$Arch.exe"
          }

          $Installer = Join-Path $env:TEMP 'swift-installer.exe'
          Write-Host "Validating Swift installer URL: $URL"
          # Quick HEAD check to fail fast if the artifact path changes
          curl.exe -sS -I --fail --location $URL
          if ($LASTEXITCODE -ne 0) { Write-Host "::error::Installer URL not reachable: $URL"; exit 1 }

          Write-Host "Downloading Swift installer with retries: $URL"
          # Use curl with retries and a max time to avoid indefinite hangs
          curl.exe -sS --fail --location --retry 5 --retry-delay 5 --max-time 900 --output $Installer $URL
          if ($LASTEXITCODE -ne 0) { Write-Host "::error::Download failed for: $URL"; exit 1 }

          $Log = Join-Path $env:TEMP 'swift-install.log'
          $Args = "/quiet /norestart /lv*x `"$Log`""
          Write-Host "Running installer silently... (log: $Log)"
          # Run without Verb RunAs to avoid UAC prompts on CI
          $Process = Start-Process -FilePath $Installer -ArgumentList $Args -Wait -PassThru
          if ($Process.ExitCode -ne 0 -and $Process.ExitCode -ne 3010) {
            Write-Host "::error::Installer returned exit code $($Process.ExitCode). See log: $Log"
            if (Test-Path $Log) { Write-Host '--- installer log (tail) ---'; Get-Content $Log -Tail 200 }
            exit $Process.ExitCode
          }

          # Refresh environment for current process so PATH includes Swift without reboot
          foreach ($level in 'Machine','User') {
            [Environment]::GetEnvironmentVariables($level).GetEnumerator() | ForEach-Object {
              if ($_.Name -eq 'Path') {
                $_.Value = ("$env:Path;$($_.Value)" -split ';' | Select-Object -Unique) -join ';'
              }
              $_
            } | Set-Content -Path { "Env:$($_.Name)" }
          }

          # Export updated PATH and env for subsequent steps
          $env:Path | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8
          Get-ChildItem Env: | ForEach-Object { "$($_.Name)=$($_.Value)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          swift --version

      - name: Update SDK module definitions (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # Determine Swift root and SDKROOT
          $SwiftExe = (Get-Command swift).Source
          if (-not $SwiftExe) { throw 'swift not found on PATH after installation.' }
          $SwiftRoot = Split-Path -Path (Split-Path -Path $SwiftExe -Parent) -Parent  # <toolchain>\usr
          if (-not $env:SDKROOT -or -not (Test-Path $env:SDKROOT)) {
            # Fallback: use <toolchain>\usr as SDKROOT
            $InferredSDKRoot = $SwiftRoot
            if (-not (Test-Path $InferredSDKRoot)) { throw "Unable to infer SDKROOT from $SwiftExe" }
            $env:SDKROOT = $InferredSDKRoot
            echo "SDKROOT=$env:SDKROOT" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

          $Targets = @{
            'WinSDK(UM) Module Map'     = @{ Url = 'https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/winsdk_um.modulemap';      Dest = Join-Path $env:SDKROOT 'usr/share/winsdk_um.modulemap' };
            'WinSDK(Shared) Module Map' = @{ Url = 'https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/winsdk_shared.modulemap';  Dest = Join-Path $env:SDKROOT 'usr/share/winsdk_shared.modulemap' };
            'UCRT Module Map'           = @{ Url = 'https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/ucrt.modulemap';          Dest = Join-Path $env:SDKROOT 'usr/share/ucrt.modulemap' };
            'VCRuntime Module Map'      = @{ Url = 'https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/vcruntime.modulemap';     Dest = Join-Path $env:SDKROOT 'usr/share/vcruntime.modulemap' };
            'VCRuntime API Notes'       = @{ Url = 'https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/vcruntime.apinotes';      Dest = Join-Path $env:SDKROOT 'usr/share/vcruntime.apinotes' };
            'Clang Module Map'          = @{ Url = 'https://raw.githubusercontent.com/llvm/llvm-project/main/clang/lib/Headers/module.modulemap';           Dest = Join-Path $SwiftRoot 'lib/swift/clang/include/module.modulemap' };
          }

          foreach ($item in $Targets.GetEnumerator()) {
            $name = $item.Key
            $url = $item.Value.Url
            $dest = $item.Value.Dest
            Write-Host "Updating $name -> $dest"
            $destDir = Split-Path -Path $dest -Parent
            if (-not (Test-Path $destDir)) { New-Item -ItemType Directory -Force -Path $destDir | Out-Null }
            curl.exe --fail --silent --show-error --retry 3 --retry-delay 5 --location $url --output $dest
            if ($LASTEXITCODE -ne 0) { Write-Host "::error::Failed to update $name"; exit 1 }
          }

      - name: Configure Git (Windows NTFS quirk)
        if: runner.os == 'Windows'
        shell: pwsh
        run: git config --global core.protectNTFS false

      - name: Print Swift Version
        run: swift --version

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build (Release)
        if: runner.os != 'Windows'
        run: swift build -c release

      # On Windows, explicitly build test bundles so we can run with --skip-build reliably
      - name: Build Tests (Release - Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          swift build -c release --build-tests

      - name: Run Full Test Suite (Release Mode - Unix)
        if: runner.os != 'Windows'
        run: |
          swift test -c release
        shell: bash

      # NOTE: Running swift test under Bash on Windows can hang due to PTY/process issues.
      # Use PowerShell, skip rebuild (we built already), and add verbosity + timeout for safety.
      - name: Run Full Test Suite (Release Mode - Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 45
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          swift --version
          Write-Host "Listing discovered tests (release, skip build)"
          swift test -c release --skip-build --list-tests
          Write-Host "Running tests (release, skip build, verbose)"
          # Use single job to reduce concurrency-related flakes on Windows file/handle operations
          swift test -c release --skip-build --verbose -j 1

      - name: Archive Build Products (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          cp -R .build/release artifacts/build-release
        shell: bash

      - name: Archive Build Products (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          # Copy the platform-specific build output for Release configuration
          $releaseDir = Join-Path ".build" "x86_64-unknown-windows-msvc/release"
          if (-not (Test-Path $releaseDir)) { Write-Host "::warning::Release build directory not found: $releaseDir" }
          else { Copy-Item -Recurse -Force $releaseDir (Join-Path "artifacts" "build-release") }

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-swift6.2
          path: artifacts